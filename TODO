
Oct 15
	voomWithQualityWeights using weights

	I think to be fully correct you would need a version of arrayWeights that does mixed models
	I think you can pretty much copy the code for limma:::.arrayWeightsGeneByGene except that you’d replace the call to lm.wfit with the equivalent mixed model fit, and then you’d probably replace the loop with equivalent BiocParallel code to make it fast.


August 25:

	write function to extra cell type counts

	compositionCounts(sce)

	cellTypeCompositionTest() 
		extend to test multiple factors at the same time
		- use cell count weights for logit frac


	variancePartition and dream uses too many threads per fork
		RhpcBLASctl?

	When there is an NA in a covariate in dreamlet,
		dream warns each time.
	Instead have dreamlet warn once

	Show progress for processAssays like for dreamlet

	Add test of effect size heterogeneity across cell types

	cell type composition:
		feed into dream/voom/eBayes to borrow information 
		glmer can't

	examples about adding metadata to processAssays()	


	Describe treatment of NA's
	Describe behavior of voom plots

	DONE
	Donghoon's error:
		A categorical variable can only be included if there is variation within that 	category.  So with the NPS-AD I included Donor because there is variation within.  When there are no replicates, you can’t include Donor since there is just one sample per donor, and no variation within.  In your case, the error is due to dropped samples.  processAssays() only keeps samples with at least min.cells in a given cluster.  In the case your replicates are dropped, Donor becomes problematic and you get this error.
	I already check of const removeConstantTerms.  But check no variation


	docs:
		There are two separate questions that variancePartition/dreamlet address: 1) estimate fraction of variance explained, 2) hypothesis test on fixed effects while accounting for random effects.  So the dream() and dreamlet() functions only perform hypothesis tests on fixed effect variables.  But fitVarPart() addresses question (1) and if any categorical variables are modeled as random, they all must be random.  Yes, a little counter-intuitive, but fixed vs random depends on the question and analysis

		
	DONE: Feed contrasts to dreamlet()
	# dreamlet() should work with SingleCellExperiment also

	DONE: type definition for zenith_gsa for GeneSetCollection

	documentation for `prepSCE`: it maps each cell to 1) a cell cluster, 2) a biological sample and 3) a donor.


	** cell counts are used as weighs in voom.
	if not counts, they are used as weights directly
	is this equivalent is the formula is just and intercept?


	Make I(x^2) formula work

	include checkFormula in variancePartition


	DONE: remove isCounts

	DONE: store extract pmetadata with metadata
	
	DONE: pmetadata is given to processAssays(). Need to store it in result
	and use it in fitVarPart() and dreamlet()






August 19,
	do R CMD check to resolve issues with Generics
	plotVarPart() should take arguments ncolumns
	zenith_gsa should work on list of cell types of 1 cell type 



August 18: DONE
	- Allow class dreamletProcessedData to be subsetted to extract subset of assays
	- plotVoom should work on one or many assays using class names
	- Extend the following plots to single or multiple
		plotVoom()
		plotVarPart()
		plotVolcano()




May 14,
	Include number of expressed genes, or other QC as covariates


Authors@R: c(person("Gabriel", "Hoffman", role = c("aut", "cre"), email = "gabriel.hoffman@mssm.edu"))

April 2,
	handle contrasts L if missing
	should dreamletProcessedData be a SingleCellExperiment?
	graceful printing of each object
	show voom plots
	how should residual covariance be weighted?


March 30, 2021
	dreamlet: dream for single cell analysis
		weight by both reads and cell number
		like muscat, except per-sample weights are used by voomWithDreamWeights
			instead of lmFit: https://github.com/HelenaLC/muscat/blob/c93966305b1317b0caf5c6eb374826d6432b4a0a/R/utils-pbDS.R#L104
		Should I weight voom or the lmFit step?

# muscat is good, but random effects are especially important for multiplexed
# 10X datasets because batches are only 6 samples.
# Weighting by samples: the variance of binomial fraction is proportional to 1/n

# depends on limma, edgeR, variancePartition
dreamlet = function(snObj, form){

	# for each cell type
	fitList = lapply( assays(snObj), function(cellType){
		
		# get data for this cell type
		geneExpr = assay(snObj, cellType)

		# get samples with enough cells
		# filter genes
		geneExpr = filterByExpr(geneExpr)

		# per sample weights
		w = weights by cell types

		# need to adapt voomByDreamWeights to allow per sample weights
		vobj = voomByDreamWeights( geneExpr, form, info, weights=w)

		# need to adapt dream to allow per sample weights
		fit = dream(vobj, form, info, weights=w)

		# finish eBayes
		# only use trend if precion weights are not available
		fit = eBayes(fit, robust, trend)

		# return full results like muscat does
		fit
	})

	# Add ashr on the results of topTable

	fitList
}

