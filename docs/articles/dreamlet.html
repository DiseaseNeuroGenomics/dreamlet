<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Dreamlet analysis of single cell RNA-seq • dreamlet</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Dreamlet analysis of single cell RNA-seq">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dreamlet</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/dreamlet.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/mashr.html">mashr analysis after dreamlet</a></li>
    <li><a class="dropdown-item" href="../articles/cell_covs.html">Modeling continuous cell-level covariates</a></li>
    <li><a class="dropdown-item" href="../articles/non_lin_eff.html">Testing non-linear effects</a></li>
    <li><a class="dropdown-item" href="../articles/h5ad_on_disk.html">Handling large H5AD datasets</a></li>
    <li><a class="dropdown-item" href="../articles/errors.html">Error handling</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DiseaseNeurogenomics/dreamlet/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Dreamlet analysis of single cell RNA-seq</h1>
            <h3 data-toc-skip class="subtitle">Linear (mixed) model
analysis of pseudobulk data</h3>
                        <h4 data-toc-skip class="author">Developed by <a href="http://gabrielhoffman.github.io/" class="external-link">Gabriel Hoffman</a>
</h4>
            
            <h4 data-toc-skip class="date">Run on 2024-10-22
16:35:09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/DiseaseNeurogenomics/dreamlet/blob/HEAD/vignettes/dreamlet.Rmd" class="external-link"><code>vignettes/dreamlet.Rmd</code></a></small>
      <div class="d-none name"><code>dreamlet.Rmd</code></div>
    </div>

    
    
<!---

cd /Users/gabrielhoffman/workspace/repos/dreamlet/vignettes

# rm -rf dreamlet_cache/

rmarkdown::render("dreamlet.Rmd")


 devtools::reload("/Users/gabrielhoffman/workspace/repos/dreamlet")

devtools::reload("/Users/gabrielhoffman/workspace/repos/zenith")



--->
<style>
body {
text-align: justify}
</style>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>As the scale of single cell/nucleus RNA-seq has increased, so has the
complexity of study designs. Analysis of datasets with simple study
designs can be performed using linear model as in the <a href="https://bioconductor.org/packages/muscat" class="external-link">muscat package</a>. Yet
analysis of datsets with complex study designs such as repeated measures
or many technical batches can benefit from linear mixed model analysis
to model to correlation structure between samples. We previously
developed <a href="https://doi.org/10.1093/bioinformatics/btaa687" class="external-link">dream</a> to apply
linear mixed models to bulk RNA-seq data using a <a href="https://bioconductor.org/packages/release/bioc/html/limma.html" class="external-link">limma</a>-style
workflow. Dreamlet extends the previous work of dream and <a href="https://www.nature.com/articles/s41467-020-19894-4" class="external-link">muscat</a> to
apply linear mixed models to pseudobulk data. Dreamlet also supports
linear models and facilitates application of 1) <a href="https://bioconductor.org/packages/variancePartition" class="external-link">variancePartition</a>
to quantify the contribution of multiple variables to expression
variation, and 2) <a href="https://github.com/GabrielHoffman/zenith" class="external-link">zenith</a> to perform
gene set analysis on the differential expression signatures.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>To install this package, start R (version “4.3”) and enter:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://bioconductor.github.io/BiocManager/" class="external-link">"BiocManager"</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Select release #1 or #2</span></span>
<span></span>
<span><span class="co"># 1) Bioconductor release</span></span>
<span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://bioconductor.github.io/BiocManager/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"dreamlet"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2) Latest stable release</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"DiseaseNeurogenomics/dreamlet"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="process-single-cell-count-data">Process single cell count data<a class="anchor" aria-label="anchor" href="#process-single-cell-count-data"></a>
</h2>
<p>Here we perform analysis of PBMCs from 8 individuals stimulated with
interferon-β (<a href="https://www.nature.com/articles/nbt.4042" class="external-link">Kang,
et al, 2018, Nature Biotech</a>). This is a small dataset that does not
have repeated measures or high dimensional batch effects, so the
sophisticated features of dreamlet are not strictly necessary. But this
gives us an opportunity to walk through a standard dreamlet
workflow.</p>
<div class="section level3">
<h3 id="preprocess-data">Preprocess data<a class="anchor" aria-label="anchor" href="#preprocess-data"></a>
</h3>
<p>Here, single cell RNA-seq data is downloaded from <a href="https://bioconductor.org/packages/ExperimentHub/" class="external-link">ExperimentHub</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://DiseaseNeurogenomics.github.io/dreamlet" class="external-link">dreamlet</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HelenaLC/muscat" class="external-link">muscat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ExperimentHub</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://DiseaseNeuroGenomics.github.io/zenith" class="external-link">zenith</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://bioconductor.org/packages/scater/" class="external-link">scater</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download data, specifying EH2259 for the Kang, et al study</span></span>
<span><span class="va">eh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ExperimentHub/man/ExperimentHub-class.html" class="external-link">ExperimentHub</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="va">eh</span><span class="op">[[</span><span class="st">"EH2259"</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">sce</span><span class="op">$</span><span class="va">ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">ind</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># only keep singlet cells with sufficient reads</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="va">sce</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/dge.html" class="external-link">counts</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="op">]</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="va">sce</span><span class="op">[</span>, <span class="fu">colData</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">multiplets</span> <span class="op">==</span> <span class="st">"singlet"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># compute QC metrics</span></span>
<span><span class="va">qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scuttle/man/perCellQCMetrics.html" class="external-link">perCellQCMetrics</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># remove cells with few or many detected genes</span></span>
<span><span class="va">ol</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scuttle/man/isOutlier.html" class="external-link">isOutlier</a></span><span class="op">(</span>metric <span class="op">=</span> <span class="va">qc</span><span class="op">$</span><span class="va">detected</span>, nmads <span class="op">=</span> <span class="fl">2</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="va">sce</span><span class="op">[</span>, <span class="op">!</span><span class="va">ol</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># set variable indicating stimulated (stim) or control (ctrl)</span></span>
<span><span class="va">sce</span><span class="op">$</span><span class="va">StimStatus</span> <span class="op">&lt;-</span> <span class="va">sce</span><span class="op">$</span><span class="va">stim</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="aggregate-to-pseudobulk">Aggregate to pseudobulk<a class="anchor" aria-label="anchor" href="#aggregate-to-pseudobulk"></a>
</h3>
<p>Dreamlet, like muscat, performs analysis at the pseudobulk-level by
summing <u>raw counts</u> across cells for a given sample and cell type.
<code>aggregateToPseudoBulk</code> is substantially faster for large
on-disk datasets than <a href="https://rdrr.io/bioc/muscat/man/aggregateData.html" class="external-link"><code>muscat::aggregateData</code></a>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Since 'ind' is the individual and 'StimStatus' is the stimulus status,</span></span>
<span><span class="co"># create unique identifier for each sample</span></span>
<span><span class="va">sce</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">StimStatus</span>, <span class="va">sce</span><span class="op">$</span><span class="va">ind</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create pseudobulk data by specifying cluster_id and sample_id</span></span>
<span><span class="co"># Count data for each cell type is then stored in the `assay` field</span></span>
<span><span class="co"># assay: entry in assayNames(sce) storing raw counts</span></span>
<span><span class="co"># cluster_id: variable in colData(sce) indicating cell clusters</span></span>
<span><span class="co"># sample_id: variable in colData(sce) indicating sample id for aggregating cells</span></span>
<span><span class="va">pb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregateToPseudoBulk.html">aggregateToPseudoBulk</a></span><span class="op">(</span><span class="va">sce</span>,</span>
<span>  assay <span class="op">=</span> <span class="st">"counts"</span>,</span>
<span>  cluster_id <span class="op">=</span> <span class="st">"cell"</span>,</span>
<span>  sample_id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># one 'assay' per cell type</span></span>
<span><span class="fu">assayNames</span><span class="op">(</span><span class="va">pb</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "B cells"           "CD14+ Monocytes"   "CD4 T cells"      </span></span>
<span><span class="co">## [4] "CD8 T cells"       "Dendritic cells"   "FCGR3A+ Monocytes"</span></span>
<span><span class="co">## [7] "Megakaryocytes"    "NK cells"</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="voom-for-pseudobulk">Voom for pseudobulk<a class="anchor" aria-label="anchor" href="#voom-for-pseudobulk"></a>
</h2>
<p>Apply <a href="https://rdrr.io/bioc/limma/man/voom.html" class="external-link">voom</a>-style
normalization for pseudobulk counts within each cell cluster using <a href="https://gabrielhoffman.github.io/variancePartition/reference/voomWithDreamWeights.html" class="external-link">voomWithDreamWeights</a>
to handle random effects (if specified).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Normalize and apply voom/voomWithDreamWeights</span></span>
<span><span class="va">res.proc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/processAssays.html">processAssays</a></span><span class="op">(</span><span class="va">pb</span>, <span class="op">~</span><span class="va">StimStatus</span>, min.count <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># the resulting object of class dreamletProcessedData stores</span></span>
<span><span class="co"># normalized data and other information</span></span>
<span><span class="va">res.proc</span></span></code></pre></div>
<pre><code><span><span class="co">## class: dreamletProcessedData </span></span>
<span><span class="co">## assays(8): B cells CD14+ Monocytes ... Megakaryocytes NK cells</span></span>
<span><span class="co">## colData(4): ind stim multiplets StimStatus</span></span>
<span><span class="co">## metadata(3): cell id cluster</span></span>
<span><span class="co">## Samples:</span></span>
<span><span class="co">##  min: 13 </span></span>
<span><span class="co">##  max: 16</span></span>
<span><span class="co">## Genes:</span></span>
<span><span class="co">##  min: 164 </span></span>
<span><span class="co">##  max: 5262 </span></span>
<span><span class="co">## details(7): assay n_retain ... n_errors error_initial</span></span></code></pre>
<p><code><a href="../reference/processAssays.html">processAssays()</a></code> retains samples with at least
<code>min.cells</code> in a given cell type. While dropping a few
samples usually is not a problem, in some cases dropping sames can mean
that a variable included in the regression formula no longer has any
variation. For example, dropping all stimulated samples from analysis of
a given cell type would be mean the variable <code>StimStatus</code> has
no variation and is perfectly colinear with the intercept term. This
colinearity issue is detected internally and variables with these
problem are dropped from the regression formula for that particular cell
type. The number of samples retained and the resulting formula used in
each cell type can be accessed as follows. In this analysis, samples are
dropped from 3 cell types but the original formula remains valid in each
case.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view details of dropping samples</span></span>
<span><span class="fu"><a href="../reference/details-methods.html">details</a></span><span class="op">(</span><span class="va">res.proc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##               assay n_retain     formula formDropsTerms n_genes n_errors</span></span>
<span><span class="co">## 1           B cells       16 ~StimStatus          FALSE    1961        0</span></span>
<span><span class="co">## 2   CD14+ Monocytes       16 ~StimStatus          FALSE    3087        0</span></span>
<span><span class="co">## 3       CD4 T cells       16 ~StimStatus          FALSE    5262        0</span></span>
<span><span class="co">## 4       CD8 T cells       16 ~StimStatus          FALSE    1030        0</span></span>
<span><span class="co">## 5   Dendritic cells       13 ~StimStatus          FALSE     164        0</span></span>
<span><span class="co">## 6 FCGR3A+ Monocytes       16 ~StimStatus          FALSE    1160        0</span></span>
<span><span class="co">## 7    Megakaryocytes       13 ~StimStatus          FALSE     172        0</span></span>
<span><span class="co">## 8          NK cells       16 ~StimStatus          FALSE    1656        0</span></span>
<span><span class="co">##   error_initial</span></span>
<span><span class="co">## 1         FALSE</span></span>
<span><span class="co">## 2         FALSE</span></span>
<span><span class="co">## 3         FALSE</span></span>
<span><span class="co">## 4         FALSE</span></span>
<span><span class="co">## 5         FALSE</span></span>
<span><span class="co">## 6         FALSE</span></span>
<span><span class="co">## 7         FALSE</span></span>
<span><span class="co">## 8         FALSE</span></span></code></pre>
<p>Here the mean-variance trend from voom is shown for each cell type.
Cell types with sufficient number of cells and reads show a clear
mean-variance trend. While in rare cell types like megakaryocytes, fewer
genes have sufficient reads and the trend is less apparent.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># show voom plot for each cell clusters</span></span>
<span><span class="fu"><a href="../reference/plotVoom-methods.html">plotVoom</a></span><span class="op">(</span><span class="va">res.proc</span><span class="op">)</span></span></code></pre></div>
<p><img src="dreamlet_files/figure-html/voom.plots-1.png" width="700"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Show plots for subset of cell clusters</span></span>
<span><span class="co"># plotVoom( res.proc[1:3] )</span></span>
<span></span>
<span><span class="co"># Show plots for one cell cluster</span></span>
<span><span class="co"># plotVoom( res.proc[["B cells"]])</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="variance-partitioning">Variance partitioning<a class="anchor" aria-label="anchor" href="#variance-partitioning"></a>
</h2>
<p>The <a href="http://bioconductor.org/packages/variancePartition/" class="external-link">variancePartition</a>
package uses linear and linear mixed models to quanify the contribution
of multiple sources of expression variation at the gene-level. For each
gene it fits a linear (mixed) model and evalutes the fraction of
expression variation explained by each variable.</p>
<p>Variance fractions can be visualized at the gene-level for each cell
type using a bar plot, or genome-wide using a violin plot.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run variance partitioning analysis</span></span>
<span><span class="va">vp.lst</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitVarPart.html">fitVarPart</a></span><span class="op">(</span><span class="va">res.proc</span>, <span class="op">~</span><span class="va">StimStatus</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Show variance fractions at the gene-level for each cell type</span></span>
<span><span class="va">genes</span> <span class="op">&lt;-</span> <span class="va">vp.lst</span><span class="op">$</span><span class="va">gene</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="fu"><a href="http://DiseaseNeurogenomics.github.io/variancePartition/reference/plotPercentBars-method.html" class="external-link">plotPercentBars</a></span><span class="op">(</span><span class="va">vp.lst</span><span class="op">[</span><span class="va">vp.lst</span><span class="op">$</span><span class="va">gene</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">genes</span>, <span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="dreamlet_files/figure-html/vp.barplt-1.png" width="700"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Summarize variance fractions genome-wide for each cell type</span></span>
<span><span class="fu"><a href="http://DiseaseNeurogenomics.github.io/variancePartition/reference/plotVarPart-method.html" class="external-link">plotVarPart</a></span><span class="op">(</span><span class="va">vp.lst</span>, label.angle <span class="op">=</span> <span class="fl">60</span><span class="op">)</span></span></code></pre></div>
<p><img src="dreamlet_files/figure-html/vp.violin-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="differential-expression">Differential expression<a class="anchor" aria-label="anchor" href="#differential-expression"></a>
</h2>
<p>Since the normalized expression data and metadata are stored within
<code>res.proc</code>, only the regression formula remains to be
specified. Here we only included the stimulus status, but analyses of
larger datasets can include covariates and random effects. With formula
<code>~ StimStatus</code>, an intercept is fit and coefficient
<code>StimStatusstim</code> log fold change between simulated and
controls.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Differential expression analysis within each assay,</span></span>
<span><span class="co"># evaluated on the voom normalized data</span></span>
<span><span class="va">res.dl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dreamlet.html">dreamlet</a></span><span class="op">(</span><span class="va">res.proc</span>, <span class="op">~</span><span class="va">StimStatus</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># names of estimated coefficients</span></span>
<span><span class="fu"><a href="../reference/coefNames-methods.html">coefNames</a></span><span class="op">(</span><span class="va">res.dl</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "(Intercept)"    "StimStatusstim"</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># the resulting object of class dreamletResult</span></span>
<span><span class="co"># stores results and other information</span></span>
<span><span class="va">res.dl</span></span></code></pre></div>
<pre><code><span><span class="co">## class: dreamletResult </span></span>
<span><span class="co">## assays(8): B cells CD14+ Monocytes ... Megakaryocytes NK cells</span></span>
<span><span class="co">## Genes:</span></span>
<span><span class="co">##  min: 164 </span></span>
<span><span class="co">##  max: 5262 </span></span>
<span><span class="co">## details(7): assay n_retain ... n_errors error_initial</span></span>
<span><span class="co">## coefNames(2): (Intercept) StimStatusstim</span></span></code></pre>
<div class="section level3">
<h3 id="volcano-plots">Volcano plots<a class="anchor" aria-label="anchor" href="#volcano-plots"></a>
</h3>
<p>The volcano plot can indicate the strength of the differential
expression signal with each cell type. Red points indicate FDR &lt;
0.05.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotVolcano-methods.html">plotVolcano</a></span><span class="op">(</span><span class="va">res.dl</span>, coef <span class="op">=</span> <span class="st">"StimStatusstim"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dreamlet_files/figure-html/plotVolcano-1.png" width="768"></p>
</div>
<div class="section level3">
<h3 id="gene-level-heatmap">Gene-level heatmap<a class="anchor" aria-label="anchor" href="#gene-level-heatmap"></a>
</h3>
<p>For each cell type and specified gene, show z-statistic from
<code>dreamlet</code> analysis. Grey indicates that insufficient reads
were observed to include the gene in the analysis.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ISG20"</span>, <span class="st">"ISG15"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plotGeneHeatmap-methods.html">plotGeneHeatmap</a></span><span class="op">(</span><span class="va">res.dl</span>, coef <span class="op">=</span> <span class="st">"StimStatusstim"</span>, genes <span class="op">=</span> <span class="va">genes</span><span class="op">)</span></span></code></pre></div>
<p><img src="dreamlet_files/figure-html/plotGeneHeatmap-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="extract-results">Extract results<a class="anchor" aria-label="anchor" href="#extract-results"></a>
</h3>
<p>Each entry in <code>res.dl</code> stores a model fit by <a href="https://rdrr.io/bioc/variancePartition/man/dream-method.html" class="external-link"><code>dream()</code></a>,
and results can be extracted using <code>topTable()</code> as in
<code>limma</code> by specifying the coefficient of interest. The
results shows the gene name, log fold change, average expression,
t-statistic, p-value, FDR (i.e. adj.P.Val).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># results from full analysis</span></span>
<span><span class="fu">topTable</span><span class="op">(</span><span class="va">res.dl</span>, coef <span class="op">=</span> <span class="st">"StimStatusstim"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 10 rows and 9 columns</span></span>
<span><span class="co">##              assay          ID     logFC   AveExpr         t     P.Value</span></span>
<span><span class="co">##        &lt;character&gt; &lt;character&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;</span></span>
<span><span class="co">## 1      CD4 T cells       ISG20   3.05455  10.40388   34.4774 3.14046e-22</span></span>
<span><span class="co">## 2      CD4 T cells        IFI6   5.66980   8.52892   33.5813 5.89835e-22</span></span>
<span><span class="co">## 3      CD4 T cells        MT2A   4.32697   7.80640   29.8959 9.44958e-21</span></span>
<span><span class="co">## 4  CD14+ Monocytes       IL1RN   7.07251   7.79103   35.1828 9.58042e-21</span></span>
<span><span class="co">## 5          B cells       ISG15   5.53079  10.20272   26.2270 1.16025e-20</span></span>
<span><span class="co">## 6      CD4 T cells       HERC5   4.23629   6.74189   29.2009 1.65334e-20</span></span>
<span><span class="co">## 7      CD4 T cells       ISG15   5.18872  10.06906   28.4163 3.15713e-20</span></span>
<span><span class="co">## 8          B cells       ISG20   3.33103  11.38360   24.1402 9.83897e-20</span></span>
<span><span class="co">## 9         NK cells       ISG15   4.76379  11.01479   24.7131 1.81450e-19</span></span>
<span><span class="co">## 10     CD4 T cells     TNFSF10   4.41588   7.49081   25.8759 2.89593e-19</span></span>
<span><span class="co">##      adj.P.Val         B     z.std</span></span>
<span><span class="co">##      &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;</span></span>
<span><span class="co">## 1  4.27395e-18   40.9592   34.4774</span></span>
<span><span class="co">## 2  4.27395e-18   40.1636   33.5813</span></span>
<span><span class="co">## 3  3.36287e-17   37.4905   29.8959</span></span>
<span><span class="co">## 4  3.36287e-17   36.7737   35.1828</span></span>
<span><span class="co">## 5  3.36287e-17   37.1705   26.2270</span></span>
<span><span class="co">## 6  3.99337e-17   36.7596   29.2009</span></span>
<span><span class="co">## 7  6.53617e-17   36.3919   28.4163</span></span>
<span><span class="co">## 8  1.78233e-16   35.1770   24.1402</span></span>
<span><span class="co">## 9  2.92175e-16   34.4633   24.7131</span></span>
<span><span class="co">## 10 4.19679e-16   34.1274   25.8759</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># only B cells</span></span>
<span><span class="fu">topTable</span><span class="op">(</span><span class="va">res.dl</span><span class="op">[[</span><span class="st">"B cells"</span><span class="op">]</span><span class="op">]</span>, coef <span class="op">=</span> <span class="st">"StimStatusstim"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           logFC   AveExpr        t      P.Value    adj.P.Val        B</span></span>
<span><span class="co">## ISG15  5.530786 10.202722 26.22702 1.160249e-20 2.275249e-17 37.17046</span></span>
<span><span class="co">## ISG20  3.331031 11.383603 24.14017 9.838971e-20 9.647111e-17 35.17704</span></span>
<span><span class="co">## LY6E   4.331290  8.706648 19.16241 3.474679e-17 2.271282e-14 29.27957</span></span>
<span><span class="co">## IRF7   3.730427  8.678591 18.84058 5.310505e-17 2.603475e-14 28.88289</span></span>
<span><span class="co">## UBE2L6 2.741292  9.241028 18.50765 8.290835e-17 3.251666e-14 28.47212</span></span>
<span><span class="co">## EPSTI1 3.716921  8.107930 18.18089 1.292430e-16 3.651223e-14 27.96522</span></span>
<span><span class="co">## PLSCR1 4.113193  8.271191 18.17475 1.303343e-16 3.651223e-14 27.96187</span></span>
<span><span class="co">## IFITM2 2.999742  8.731566 17.76966 2.282011e-16 5.593779e-14 27.46272</span></span>
<span><span class="co">## SAT1   2.206045  9.657178 17.41720 3.748297e-16 8.167123e-14 26.94871</span></span>
<span><span class="co">## SOCS1  2.432287  8.588454 16.28257 1.965142e-15 3.853644e-13 25.32548</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="forest-plot">Forest plot<a class="anchor" aria-label="anchor" href="#forest-plot"></a>
</h3>
<p>A forest plot shows the log fold change and standard error of a given
gene across all cell types. The color indicates the FDR.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotForest-methods.html">plotForest</a></span><span class="op">(</span><span class="va">res.dl</span>, coef <span class="op">=</span> <span class="st">"StimStatusstim"</span>, gene <span class="op">=</span> <span class="st">"ISG20"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dreamlet_files/figure-html/forrest-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="box-plot">Box plot<a class="anchor" aria-label="anchor" href="#box-plot"></a>
</h3>
<p>Examine the expression of ISG20 between stimulation conditions within
CD14+ Monocytes. Use <code><a href="../reference/extractData-methods.html">extractData()</a></code> to create a
<code>tibble</code> with gene expression data and metadata from
<code>colData()</code> from one cell type.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get data</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extractData-methods.html">extractData</a></span><span class="op">(</span><span class="va">res.proc</span>, <span class="st">"CD14+ Monocytes"</span>, genes <span class="op">=</span> <span class="st">"ISG20"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set theme</span></span>
<span><span class="va">thm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span>, plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">StimStatus</span>, <span class="va">ISG20</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">thm</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="va">Expression</span> <span class="op">~</span> <span class="op">(</span><span class="va">log</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">~</span> <span class="va">CPM</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"ISG20"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dreamlet_files/figure-html/boxplot-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="advanced-used-of-contrasts">Advanced used of contrasts<a class="anchor" aria-label="anchor" href="#advanced-used-of-contrasts"></a>
</h3>
<p>A hypothesis test of the <em>difference</em> between two or more
coefficients can be performed using contrasts. The contrast matrix is
evaluated for each cell type in the backend, so only the contrast string
must be supplied to <code><a href="../reference/dreamlet.html">dreamlet()</a></code>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a contrasts called 'Diff' that is the difference between expression</span></span>
<span><span class="co"># in the stimulated and controls.</span></span>
<span><span class="co"># More than one can be specified</span></span>
<span><span class="va">contrasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>Diff <span class="op">=</span> <span class="st">"StimStatusstim - StimStatusctrl"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Evalaute the regression model without an intercept term.</span></span>
<span><span class="co"># Instead estimate the mean expression in stimulated, controls and then</span></span>
<span><span class="co"># set Diff to the difference between the two</span></span>
<span><span class="va">res.dl2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dreamlet.html">dreamlet</a></span><span class="op">(</span><span class="va">res.proc</span>, <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">StimStatus</span>, contrasts <span class="op">=</span> <span class="va">contrasts</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># see estimated coefficients</span></span>
<span><span class="fu"><a href="../reference/coefNames-methods.html">coefNames</a></span><span class="op">(</span><span class="va">res.dl2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Diff"           "StimStatusctrl" "StimStatusstim"</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Volcano plot of Diff</span></span>
<span><span class="fu"><a href="../reference/plotVolcano-methods.html">plotVolcano</a></span><span class="op">(</span><span class="va">res.dl2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, coef <span class="op">=</span> <span class="st">"Diff"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dreamlet_files/figure-html/dreamlet.contrasts-1.png" width="700"></p>
<p>This new <code>Diff</code> variable can then be used downstream for
analysis asking for a coefficient. But note that since there is no
intercept term in this model, the meaning of <code>StimStatusstim</code>
changes here. When the formula is <code>0 + StimStatus</code> then
<code>StimStatusstim</code> is the mean expression in stimulated
samples.</p>
<p>For further information about using contrasts see <a href="https://gabrielhoffman.github.io/variancePartition/reference/makeContrastsDream.html" class="external-link">makeContrastsDream()</a>
and <a href="https://gabrielhoffman.github.io/variancePartition/articles/dream.html#advanced-hypothesis-testing-1" class="external-link">vignette</a>.</p>
</div>
</div>
<div class="section level2">
<h2 id="gene-set-analysis">Gene set analysis<a class="anchor" aria-label="anchor" href="#gene-set-analysis"></a>
</h2>
<p>While standard enrichment methods like Fishers exact test, requires
specifying a FDR cutoff to identify differentially expressed genes.
However, dichotomizing differential expression results is often too
simple and ignores the quantitative variation captured by the
differential expression test statistics. Here we use
<code>zenith</code>, a wrapper for <a href="https://rdrr.io/bioc/limma/man/camera.html" class="external-link"><code>limma::camera</code></a>,
to perform gene set analysis using the full spectrum of differential
expression test statistics. <code>zenith/camera</code> is a <a href="https://www.nature.com/articles/nrg.2016.29" class="external-link">competetive test</a>
that compares the mean test statistic for genes in a given gene set, to
genes not in that set while accounting for correlation between
genes.</p>
<p>Here, <code>zenith_gsa</code> takes a <code>dreamletResult</code>
object, the coefficient of interest, and gene sets as a
<code>GeneSetCollection</code> object from <a href="https://bioconductor.org/packages/GSEABase/" class="external-link">GSEABase</a>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load Gene Ontology database</span></span>
<span><span class="co"># use gene 'SYMBOL', or 'ENSEMBL' id</span></span>
<span><span class="co"># use get_MSigDB() to load MSigDB</span></span>
<span><span class="co"># Use Cellular Component (i.e. CC) to reduce run time here</span></span>
<span><span class="va">go.gs</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://gabrielhoffman.github.io/zenith/reference/get_GeneOntology.html" class="external-link">get_GeneOntology</a></span><span class="op">(</span><span class="st">"CC"</span>, to <span class="op">=</span> <span class="st">"SYMBOL"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run zenith gene set analysis on result of dreamlet</span></span>
<span><span class="va">res_zenith</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://gabrielhoffman.github.io/zenith/reference/zenith_gsa-methods.html" class="external-link">zenith_gsa</a></span><span class="op">(</span><span class="va">res.dl</span>, coef <span class="op">=</span> <span class="st">"StimStatusstim"</span>, <span class="va">go.gs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># examine results for each ell type and gene set</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">res_zenith</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     assay           coef</span></span>
<span><span class="co">## 1 B cells StimStatusstim</span></span>
<span><span class="co">## 2 B cells StimStatusstim</span></span>
<span><span class="co">## 3 B cells StimStatusstim</span></span>
<span><span class="co">## 4 B cells StimStatusstim</span></span>
<span><span class="co">## 5 B cells StimStatusstim</span></span>
<span><span class="co">## 6 B cells StimStatusstim</span></span>
<span><span class="co">##                                                        Geneset NGenes</span></span>
<span><span class="co">## 1                                GO0022626: cytosolic ribosome     81</span></span>
<span><span class="co">## 2                 GO0022625: cytosolic large ribosomal subunit     47</span></span>
<span><span class="co">## 3 GO0090575: RNA polymerase II transcription regulator complex     38</span></span>
<span><span class="co">## 4                          GO0000151: ubiquitin ligase complex     33</span></span>
<span><span class="co">## 5                                   GO0032587: ruffle membrane     13</span></span>
<span><span class="co">## 6                                          GO0005840: ribosome    145</span></span>
<span><span class="co">##   Correlation      delta        se      p.less  p.greater      PValue Direction</span></span>
<span><span class="co">## 1        0.01 -1.0883389 0.3446923 0.003493894 0.99650611 0.006987787      Down</span></span>
<span><span class="co">## 2        0.01 -1.0478410 0.4069418 0.011012959 0.98898704 0.022025917      Down</span></span>
<span><span class="co">## 3        0.01  1.0388011 0.4381026 0.983689509 0.01631049 0.032620982        Up</span></span>
<span><span class="co">## 4        0.01  1.0798671 0.4611852 0.982741172 0.01725883 0.034517656        Up</span></span>
<span><span class="co">## 5        0.01 -1.5672380 0.6746900 0.017880611 0.98211939 0.035761223      Down</span></span>
<span><span class="co">## 6        0.01 -0.6905376 0.3016455 0.019060019 0.98093998 0.038120038      Down</span></span>
<span><span class="co">##         FDR</span></span>
<span><span class="co">## 1 0.2533390</span></span>
<span><span class="co">## 2 0.4722673</span></span>
<span><span class="co">## 3 0.5003557</span></span>
<span><span class="co">## 4 0.5112761</span></span>
<span><span class="co">## 5 0.5130662</span></span>
<span><span class="co">## 6 0.5315479</span></span></code></pre>
<div class="section level3">
<h3 id="heatmap-of-top-genesets">Heatmap of top genesets<a class="anchor" aria-label="anchor" href="#heatmap-of-top-genesets"></a>
</h3>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for each cell type select 5 genesets with largest t-statistic</span></span>
<span><span class="co"># and 1 geneset with the lowest</span></span>
<span><span class="co"># Grey boxes indicate the gene set could not be evaluted because</span></span>
<span><span class="co">#    to few genes were represented</span></span>
<span><span class="fu"><a href="http://gabrielhoffman.github.io/zenith/reference/plotZenithResults.html" class="external-link">plotZenithResults</a></span><span class="op">(</span><span class="va">res_zenith</span>, <span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="dreamlet_files/figure-html/heatmap-1.png" width="768"></p>
<div class="section level4">
<h4 id="all-gene-sets-with-fdr-30">All gene sets with FDR &lt; 30%<a class="anchor" aria-label="anchor" href="#all-gene-sets-with-fdr-30"></a>
</h4>
<p>Here, show all genes with FDR &lt; 5% in any cell type</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get genesets with FDR &lt; 30%</span></span>
<span><span class="co"># Few significant genesets because uses Cellular Component (i.e. CC)</span></span>
<span><span class="va">gs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">res_zenith</span><span class="op">$</span><span class="va">Geneset</span><span class="op">[</span><span class="va">res_zenith</span><span class="op">$</span><span class="va">FDR</span> <span class="op">&lt;</span> <span class="fl">0.3</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># keep only results of these genesets</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">res_zenith</span><span class="op">[</span><span class="va">res_zenith</span><span class="op">$</span><span class="va">Geneset</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">gs</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># plot results, but with no limit based on the highest/lowest t-statistic</span></span>
<span><span class="fu"><a href="http://gabrielhoffman.github.io/zenith/reference/plotZenithResults.html" class="external-link">plotZenithResults</a></span><span class="op">(</span><span class="va">df</span>, <span class="cn">Inf</span>, <span class="cn">Inf</span><span class="op">)</span></span></code></pre></div>
<p><img src="dreamlet_files/figure-html/heatmap2-1.png" width="768"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="comparing-expression-in-clusters">Comparing expression in clusters<a class="anchor" aria-label="anchor" href="#comparing-expression-in-clusters"></a>
</h2>
<p>Identifying genes that are differentially expressed between cell
clusters incorporates a paired analysis design, since each individual is
observed for each cell cluster.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># test differential expression between B cells and the rest of the cell clusters</span></span>
<span><span class="va">ct.pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CD4 T cells"</span>, <span class="st">"rest"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dreamletCompareClusters.html">dreamletCompareClusters</a></span><span class="op">(</span><span class="va">pb</span>, <span class="va">ct.pairs</span>, method <span class="op">=</span> <span class="st">"fixed"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The coefficient 'compare' is the value logFC between test and baseline:</span></span>
<span><span class="co"># compare = cellClustertest - cellClusterbaseline</span></span>
<span><span class="va">df_Bcell</span> <span class="op">&lt;-</span> <span class="fu">topTable</span><span class="op">(</span><span class="va">fit</span>, coef <span class="op">=</span> <span class="st">"compare"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df_Bcell</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                             logFC   AveExpr         t      P.Value    adj.P.Val</span></span>
<span><span class="co">## TYROBP                  -7.414914  7.917618 -90.80445 6.842120e-32 3.215797e-28</span></span>
<span><span class="co">## FTL                     -4.940092 13.169468 -66.22295 1.268317e-28 2.980544e-25</span></span>
<span><span class="co">## CD63                    -5.078535  8.760309 -59.02003 1.962995e-27 3.075358e-24</span></span>
<span><span class="co">## C15orf48                -7.280995  8.398874 -54.88795 1.101340e-26 1.294075e-23</span></span>
<span><span class="co">## HLA-DRA_ENSG00000204287 -6.420347  8.865795 -52.50758 3.155315e-26 2.965996e-23</span></span>
<span><span class="co">## CCL2                    -7.288475  8.725990 -52.05456 3.875641e-26 3.035919e-23</span></span>
<span><span class="co">##                                B</span></span>
<span><span class="co">## TYROBP                  61.56044</span></span>
<span><span class="co">## FTL                     55.69682</span></span>
<span><span class="co">## CD63                    52.81595</span></span>
<span><span class="co">## C15orf48                51.05221</span></span>
<span><span class="co">## HLA-DRA_ENSG00000204287 50.11427</span></span>
<span><span class="co">## CCL2                    49.86496</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="gene-cluster-specificity">Gene-cluster specificity<a class="anchor" aria-label="anchor" href="#gene-cluster-specificity"></a>
</h2>
<p>Evaluate the specificity of each gene for each cluster, retaining
only highly expressed genes:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_cts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cellTypeSpecificity.html">cellTypeSpecificity</a></span><span class="op">(</span><span class="va">pb</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># retain only genes with total CPM summed across cell type &gt; 100</span></span>
<span><span class="va">df_cts</span> <span class="op">&lt;-</span> <span class="va">df_cts</span><span class="op">[</span><span class="va">df_cts</span><span class="op">$</span><span class="va">totalCPM</span> <span class="op">&gt;</span> <span class="fl">100</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Violin plot of specificity score for each cell type</span></span>
<span><span class="fu"><a href="../reference/plotViolin-methods.html">plotViolin</a></span><span class="op">(</span><span class="va">df_cts</span><span class="op">)</span></span></code></pre></div>
<p><img src="dreamlet_files/figure-html/cellTypeSpecificity-1.png" width="700"></p>
<p>Highlight expression fraction for most specific gene from each cell
type:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">df_cts</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">df_cts</span>, <span class="fl">2</span>, <span class="va">which.max</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="http://DiseaseNeurogenomics.github.io/variancePartition/reference/plotPercentBars-method.html" class="external-link">plotPercentBars</a></span><span class="op">(</span><span class="va">df_cts</span>, genes <span class="op">=</span> <span class="va">genes</span><span class="op">)</span></span></code></pre></div>
<p><img src="dreamlet_files/figure-html/plotPercentBars-1.png" width="700"></p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dreamlet</span><span class="fu">::</span><span class="fu"><a href="../reference/plotHeatmap-methods.html">plotHeatmap</a></span><span class="op">(</span><span class="va">df_cts</span>, genes <span class="op">=</span> <span class="va">genes</span><span class="op">)</span></span></code></pre></div>
<p><img src="dreamlet_files/figure-html/plotPercentBars-2.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<details><pre><code><span><span class="co">## R version 4.4.0 (2024-04-24)</span></span>
<span><span class="co">## Platform: aarch64-apple-darwin23.5.0</span></span>
<span><span class="co">## Running under: macOS Sonoma 14.6.1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib </span></span>
<span><span class="co">## LAPACK: /Users/gabrielhoffman/prog/R-4.4.0/lib/libRlapack.dylib;  LAPACK version 3.12.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: America/New_York</span></span>
<span><span class="co">## tzcode source: internal</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] GO.db_3.19.1                org.Hs.eg.db_3.19.1        </span></span>
<span><span class="co">##  [3] AnnotationDbi_1.66.0        muscData_1.18.0            </span></span>
<span><span class="co">##  [5] scater_1.32.1               scuttle_1.14.0             </span></span>
<span><span class="co">##  [7] zenith_1.6.0                ExperimentHub_2.12.0       </span></span>
<span><span class="co">##  [9] AnnotationHub_3.12.0        BiocFileCache_2.12.0       </span></span>
<span><span class="co">## [11] dbplyr_2.5.0                muscat_1.18.0              </span></span>
<span><span class="co">## [13] dreamlet_1.3.3              SingleCellExperiment_1.26.0</span></span>
<span><span class="co">## [15] SummarizedExperiment_1.34.0 Biobase_2.64.0             </span></span>
<span><span class="co">## [17] GenomicRanges_1.56.1        GenomeInfoDb_1.40.1        </span></span>
<span><span class="co">## [19] IRanges_2.38.1              S4Vectors_0.42.1           </span></span>
<span><span class="co">## [21] BiocGenerics_0.50.0         MatrixGenerics_1.16.0      </span></span>
<span><span class="co">## [23] matrixStats_1.4.1           variancePartition_1.35.5   </span></span>
<span><span class="co">## [25] BiocParallel_1.38.0         limma_3.60.4               </span></span>
<span><span class="co">## [27] ggplot2_3.5.1               BiocStyle_2.32.1           </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] fs_1.6.4                  bitops_1.0-8             </span></span>
<span><span class="co">##   [3] httr_1.4.7                RColorBrewer_1.1-3       </span></span>
<span><span class="co">##   [5] doParallel_1.0.17         Rgraphviz_2.48.0         </span></span>
<span><span class="co">##   [7] numDeriv_2016.8-1.1       tools_4.4.0              </span></span>
<span><span class="co">##   [9] sctransform_0.4.1         backports_1.5.0          </span></span>
<span><span class="co">##  [11] utf8_1.2.4                R6_2.5.1                 </span></span>
<span><span class="co">##  [13] metafor_4.6-0             mgcv_1.9-1               </span></span>
<span><span class="co">##  [15] GetoptLong_1.0.5          withr_3.0.1              </span></span>
<span><span class="co">##  [17] prettyunits_1.2.0         gridExtra_2.3            </span></span>
<span><span class="co">##  [19] cli_3.6.3                 textshaping_0.4.0        </span></span>
<span><span class="co">##  [21] labeling_0.4.3            sass_0.4.9               </span></span>
<span><span class="co">##  [23] KEGGgraph_1.64.0          SQUAREM_2021.1           </span></span>
<span><span class="co">##  [25] mvtnorm_1.3-1             blme_1.0-6               </span></span>
<span><span class="co">##  [27] pkgdown_2.1.1             mixsqp_0.3-54            </span></span>
<span><span class="co">##  [29] systemfonts_1.1.0         parallelly_1.38.0        </span></span>
<span><span class="co">##  [31] invgamma_1.1              RSQLite_2.3.7            </span></span>
<span><span class="co">##  [33] generics_0.1.3            shape_1.4.6.1            </span></span>
<span><span class="co">##  [35] gtools_3.9.5              dplyr_1.1.4              </span></span>
<span><span class="co">##  [37] Matrix_1.7-0              metadat_1.2-0            </span></span>
<span><span class="co">##  [39] ggbeeswarm_0.7.2          fansi_1.0.6              </span></span>
<span><span class="co">##  [41] abind_1.4-8               lifecycle_1.0.4          </span></span>
<span><span class="co">##  [43] yaml_2.3.10               edgeR_4.2.1              </span></span>
<span><span class="co">##  [45] mathjaxr_1.6-0            gplots_3.1.3.1           </span></span>
<span><span class="co">##  [47] SparseArray_1.4.8         grid_4.4.0               </span></span>
<span><span class="co">##  [49] blob_1.2.4                crayon_1.5.3             </span></span>
<span><span class="co">##  [51] lattice_0.22-6            beachmat_2.20.0          </span></span>
<span><span class="co">##  [53] msigdbr_7.5.1             annotate_1.82.0          </span></span>
<span><span class="co">##  [55] KEGGREST_1.44.1           pillar_1.9.0             </span></span>
<span><span class="co">##  [57] knitr_1.48                ComplexHeatmap_2.20.0    </span></span>
<span><span class="co">##  [59] rjson_0.2.23              boot_1.3-31              </span></span>
<span><span class="co">##  [61] corpcor_1.6.10            future.apply_1.11.2      </span></span>
<span><span class="co">##  [63] codetools_0.2-20          glue_1.8.0               </span></span>
<span><span class="co">##  [65] data.table_1.16.0         vctrs_0.6.5              </span></span>
<span><span class="co">##  [67] png_0.1-8                 Rdpack_2.6.1             </span></span>
<span><span class="co">##  [69] gtable_0.3.5              assertthat_0.2.1         </span></span>
<span><span class="co">##  [71] cachem_1.1.0              xfun_0.47                </span></span>
<span><span class="co">##  [73] mime_0.12                 rbibutils_2.2.16         </span></span>
<span><span class="co">##  [75] S4Arrays_1.4.1            Rfast_2.1.0              </span></span>
<span><span class="co">##  [77] iterators_1.0.14          statmod_1.5.0            </span></span>
<span><span class="co">##  [79] nlme_3.1-166              pbkrtest_0.5.3           </span></span>
<span><span class="co">##  [81] bit64_4.5.2               filelock_1.0.3           </span></span>
<span><span class="co">##  [83] progress_1.2.3            EnvStats_3.0.0           </span></span>
<span><span class="co">##  [85] bslib_0.8.0               TMB_1.9.15               </span></span>
<span><span class="co">##  [87] irlba_2.3.5.1             vipor_0.4.7              </span></span>
<span><span class="co">##  [89] KernSmooth_2.23-24        colorspace_2.1-1         </span></span>
<span><span class="co">##  [91] rmeta_3.0                 DBI_1.2.3                </span></span>
<span><span class="co">##  [93] DESeq2_1.44.0             tidyselect_1.2.1         </span></span>
<span><span class="co">##  [95] curl_5.2.3                bit_4.5.0                </span></span>
<span><span class="co">##  [97] compiler_4.4.0            graph_1.82.0             </span></span>
<span><span class="co">##  [99] BiocNeighbors_1.22.0      desc_1.4.3               </span></span>
<span><span class="co">## [101] DelayedArray_0.30.1       bookdown_0.40            </span></span>
<span><span class="co">## [103] scales_1.3.0              caTools_1.18.3           </span></span>
<span><span class="co">## [105] remaCor_0.0.18            rappdirs_0.3.3           </span></span>
<span><span class="co">## [107] stringr_1.5.1             digest_0.6.37            </span></span>
<span><span class="co">## [109] minqa_1.2.8               rmarkdown_2.28           </span></span>
<span><span class="co">## [111] aod_1.3.3                 XVector_0.44.0           </span></span>
<span><span class="co">## [113] RhpcBLASctl_0.23-42       htmltools_0.5.8.1        </span></span>
<span><span class="co">## [115] pkgconfig_2.0.3           lme4_1.1-35.5            </span></span>
<span><span class="co">## [117] sparseMatrixStats_1.16.0  highr_0.11               </span></span>
<span><span class="co">## [119] mashr_0.2.79              fastmap_1.2.0            </span></span>
<span><span class="co">## [121] rlang_1.1.4               GlobalOptions_0.1.2      </span></span>
<span><span class="co">## [123] htmlwidgets_1.6.4         UCSC.utils_1.0.0         </span></span>
<span><span class="co">## [125] DelayedMatrixStats_1.26.0 farver_2.1.2             </span></span>
<span><span class="co">## [127] jquerylib_0.1.4           jsonlite_1.8.9           </span></span>
<span><span class="co">## [129] BiocSingular_1.20.0       RCurl_1.98-1.16          </span></span>
<span><span class="co">## [131] magrittr_2.0.3            GenomeInfoDbData_1.2.12  </span></span>
<span><span class="co">## [133] munsell_0.5.1             Rcpp_1.0.13              </span></span>
<span><span class="co">## [135] babelgene_22.9            viridis_0.6.5            </span></span>
<span><span class="co">## [137] EnrichmentBrowser_2.34.1  RcppZiggurat_0.1.6       </span></span>
<span><span class="co">## [139] stringi_1.8.4             zlibbioc_1.50.0          </span></span>
<span><span class="co">## [141] MASS_7.3-61               plyr_1.8.9               </span></span>
<span><span class="co">## [143] listenv_0.9.1             parallel_4.4.0           </span></span>
<span><span class="co">## [145] ggrepel_0.9.6             Biostrings_2.72.1        </span></span>
<span><span class="co">## [147] splines_4.4.0             hms_1.1.3                </span></span>
<span><span class="co">## [149] circlize_0.4.16           locfit_1.5-9.10          </span></span>
<span><span class="co">## [151] reshape2_1.4.4            ScaledMatrix_1.12.0      </span></span>
<span><span class="co">## [153] BiocVersion_3.19.1        XML_3.99-0.17            </span></span>
<span><span class="co">## [155] evaluate_1.0.0            RcppParallel_5.1.9       </span></span>
<span><span class="co">## [157] BiocManager_1.30.25       nloptr_2.1.1             </span></span>
<span><span class="co">## [159] foreach_1.5.2             tidyr_1.3.1              </span></span>
<span><span class="co">## [161] purrr_1.0.2               future_1.34.0            </span></span>
<span><span class="co">## [163] clue_0.3-65               scattermore_1.2          </span></span>
<span><span class="co">## [165] ashr_2.2-63               rsvd_1.0.5               </span></span>
<span><span class="co">## [167] broom_1.0.6               xtable_1.8-4             </span></span>
<span><span class="co">## [169] fANCOVA_0.6-1             viridisLite_0.4.2        </span></span>
<span><span class="co">## [171] ragg_1.3.3                truncnorm_1.0-9          </span></span>
<span><span class="co">## [173] tibble_3.2.1              lmerTest_3.1-3           </span></span>
<span><span class="co">## [175] glmmTMB_1.1.9             memoise_2.0.1            </span></span>
<span><span class="co">## [177] beeswarm_0.4.0            cluster_2.1.6            </span></span>
<span><span class="co">## [179] globals_0.16.3            GSEABase_1.66.0</span></span></code></pre>
</details>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="http://gabrielhoffman.github.io" class="external-link">Gabriel Hoffman</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
