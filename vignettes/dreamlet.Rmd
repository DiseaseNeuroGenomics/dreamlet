---
title: "Dreamlet analysis of single cell RNA-seq"
subtitle: 'Linear mixed model analysis of pseudobulk'
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
documentclass: article
abstract: >
 As the scale of single cell/nucleus RNA-seq has increased, so has the complexity of study designs.  Analysis of datasets with simple study designs can be performed using linear model as in the [muscat package](https://bioconductor.org/packages/muscat).  Yet analysis of datsets with complex study designs such as repeated measures or many technical batches can benefit from linear mixed model analysis to model to correlation structure between samples.  Dreamlet extends the previous work of [muscat](https://www.nature.com/articles/s41467-020-19894-4) to apply linear mixed models to pseudobulk data.  Dreamlet also supports linear models and facilitates application of 1) [variancePartition](https://bioconductor.org/packages/variancePartition) to quantify the contribution of multiple variables to expression variation, and 2) [zenith](https://github.com/GabrielHoffman/zenith) to perform gene set analysis on the differential expression signatures. 
vignette: >
  %\VignetteIndexEntry{Dreamlet analysis of single cell RNA-seq}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\usepackage[utf8]{inputenc}
output:
  html_document:
    toc: true
    toc_float: true
---

<!---

cd /Users/gabrielhoffman/workspace/repos/variancePartition/vignettes

rmarkdown::render("dreamlet.Rmd")


 devtools::reload("/Users/gabrielhoffman/workspace/repos/dreamlet")

devtools::reload("/Users/gabrielhoffman/workspace/repos/zenith")



--->



```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  dev = c("png", "pdf"),
  cache = TRUE)
```

Describe pseudobulk, complex study design, variancePartition, and zenith.

# Process single cell counts
## Preprocess data
```{r preprocess.data}
library(dreamlet)
library(muscat)
library(ExperimentHub)
library(cowplot)
library(zenith)
library(scater)

eh <- ExperimentHub()
sce <- eh[["EH2259"]]
sce <- sce[rowSums(counts(sce) > 0) > 0, ]

qc <- perCellQCMetrics(sce)

# remove cells with few or many detected genes
ol <- isOutlier(metric = qc$detected, nmads = 2, log = TRUE)
sce <- sce[, !ol]

sce <- sce[rowSums(counts(sce) > 1) >= 10, ]
sce <- computeLibraryFactors(sce)
sce <- logNormCounts(sce)
```

## Aggregate to pseudobulk
```{r aggregate}
sce$id <- paste0(sce$stim, sce$ind)
sce <- prepSCE(sce, 
    kid = "cell", # subpopulation assignments
    gid = "stim",  # group IDs (ctrl/stim)
    sid = "id",   # sample IDs (ctrl/stim.1234)
    drop = TRUE)

pb <- aggregateData(sce,
    assay = "counts", fun = "sum",
    by = c("cluster_id", "sample_id"))

# one sheet per subpopulation
assayNames(pb)
```

# Voom for pseudobulk 
```{r dreamlet, fig.width=9, fig.height=10}
# Normalize and apply voom
res.proc = processAssays( pb, ~ group_id, min.count=5)

res.proc
  
plotVoom( res.proc)
```


# Run variancePartition analysis
```{r vp}
vp.lst = fitVarPart( res.proc, ~ group_id)
```

## variancePartition plots
```{r plot.fitVarPart, fig.width=9, fig.height=10}
# show variancePartition plots for each cell type
fitList = lapply( names(vp.lst), function(cellType){
	plotVarPart(vp.lst[[cellType]], main=cellType)
	})

plot_grid(plotlist = fitList, ncol=3)
```

# Run dreamlet
```{r test}
# Differential expression analysis within each assay
res.dl = dreamlet( res.proc, ~ group_id)
```

## Volcano plot for each cell type
```{r plotVolcano, fig.width=9, fig.height=10}
plotVolcano_grid( res.dl, coef = 'group_idstim' )
```

## Extract results
```{r extract}
fit = res.dl[["B cells"]]
topTable(fit, coef = 'group_idstim' )
```

## Forrest plot 
```{r forrest}
plotForrest( res.dl, coef = 'group_idstim', gene = 'IRF7')
```



# Gene set analysis using zenith
```{r zenith}
# Load Gene Ontology database 
# use gene SYMBOL
go.gs = get_GeneOntology(to="SYMBOL")
     
# convert from GeneSetCollection to list used by camera and zenith
geneSets_GO = recodeToList( go.gs )
   
# Run zenith gene set analysis on result of dreamlet
res_zenith = zenith_gsa(res.dl, coef = 'group_idstim', geneSets_GO)

# examine results
head(res_zenith)
```

## Heatmap of top genesets
```{r heatmap, fig.height=10, fig.width=5}
# for each cell type select 5 genesets with largest t-statistic
# and 1 geneset with the lowest
plotZenithResults(res_zenith, 5, 1)
```

### All gene sets with FDR < 5%

```{r heatmap2, fig.height=10, fig.width=5}
# get genesets with FDR < 5%
gs = unique(res_zenith$Geneset[res_zenith$FDR < 0.05])

# keep only results of these genesets
df = res_zenith[res_zenith$Geneset %in% gs,]

# plot results, but with no limit based on the highest/lowest t-statistic
plotZenithResults(df, Inf, Inf)
```































